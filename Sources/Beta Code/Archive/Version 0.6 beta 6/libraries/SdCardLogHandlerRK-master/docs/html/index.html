<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SdCardLogHandlerRK: SdCardLogHandlerRK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SdCardLogHandlerRK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SdCardLogHandlerRK </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Library for writing rotating logs to SD card on the Particle Photon and Electron</em></p>
<p>The <a href="http://rickkas7.github.io/SdCardLogHandlerRK/">full browsable API documentation is here</a>.</p>
<p>The official location for this library is: <a href="https://github.com/rickkas7/SdCardLogHandlerRK">https://github.com/rickkas7/SdCardLogHandlerRK</a>.</p>
<p>It's in the Particle community libraries as: SdCardLogHandlerRK.</p>
<p>It's also possible (as of version 0.0.5) to use this to write an arbitrary stream of data, not hooked into the logging API. See <a class="el" href="class_sd_card_print_handler.html" title="Class for writing a data stream to SD card. ">SdCardPrintHandler</a>, below.</p>
<h2>Hardware</h2>
<p>You'll need a SD card reader, presumably a Micro SD card reader. Make sure you get one that's compatible with the 3.3V logic levels used on the Photon and Electron. Some readers designed for the Arduino expect the 5V logic levels used by the original Arduino. I use <a href="https://www.sparkfun.com/products/13743">this one from Sparkfun</a> but there are others. <a href="https://www.adafruit.com/product/254">This one from Adafruit</a> works as well.</p>
<div class="image">
<img src="photon.jpg" alt="photon.jpg"/>
<div class="caption">
Photon</div></div>
 <div class="image">
<img src="electron.jpg" alt="electron.jpg"/>
<div class="caption">
Electron</div></div>
<p> The SD card reader connects via the SPI interface. There are two SPI interfaces on the Photon and Electron and you can use either. Note that each SPI device must have a separate SS (sometimes called CS) pin. While it's listed in the table below as A2 (or D5), you can use any GPIO pin.</p>
<p>Primary SPI (SPI object)</p>
<ul>
<li>A2 SS</li>
<li>A3 SCK</li>
<li>A4 MISO</li>
<li>A5 MOSI</li>
</ul>
<p>Secondary SPI (SPI1 object)</p>
<ul>
<li>D5 SS</li>
<li>D4 SCK</li>
<li>D3 MISO</li>
<li>D2 MOSI</li>
</ul>
<p>In the picture above:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Device  </th><th class="markdownTableHeadNone">SPI Name  </th><th class="markdownTableHeadNone">SD Reader  </th><th class="markdownTableHeadNone">Color   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">A2  </td><td class="markdownTableBodyNone">SS  </td><td class="markdownTableBodyNone">/CS  </td><td class="markdownTableBodyNone">Yellow   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">A3  </td><td class="markdownTableBodyNone">SCK  </td><td class="markdownTableBodyNone">SCK  </td><td class="markdownTableBodyNone">Orange   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">A4  </td><td class="markdownTableBodyNone">MISO  </td><td class="markdownTableBodyNone">DO  </td><td class="markdownTableBodyNone">Blue   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">A5  </td><td class="markdownTableBodyNone">MOSI  </td><td class="markdownTableBodyNone">DI  </td><td class="markdownTableBodyNone">Green   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">3V3  </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">VCC  </td><td class="markdownTableBodyNone">Red   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">Black   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">CD  </td><td class="markdownTableBodyNone"></td></tr>
</table>
<h3>Adafruit AdaLogger FeatherWing</h3>
<p>You can also use the <a href="https://www.adafruit.com/product/2922">Adafruit AdaLogger FeatherWing</a>. It contains an SD card reader and a RTC (real-time clock).</p>
<div class="image">
<img src="feather-logger.jpg" alt="feather-logger.jpg"/>
<div class="caption">
Adafruit Feather AdaLogger</div></div>
<p> It connects to primary SPI (SPI object). The default connection is D5 for the SD card CS pin. It's possible to cut a trace and add a jumper wire to change the CS pin.</p>
<ul>
<li>D5 CS</li>
<li>A3 SCK</li>
<li>A4 MISO</li>
<li>A5 MOSI</li>
</ul>
<h2>Using the library</h2>
<p>This library uses the <a href="https://docs.particle.io/reference/firmware/#logging">Logging API</a> that was added in system firmware 0.6.0.</p>
<p>For example:</p>
<div class="fragment"><div class="line">Log.trace(&quot;Low level debugging message&quot;);</div><div class="line">Log.info(&quot;This is info message&quot;);</div><div class="line">Log.warn(&quot;This is warning message&quot;);</div><div class="line">Log.error(&quot;This is error message&quot;);</div><div class="line"></div><div class="line">Log.info(&quot;System version: %s&quot;, System.version().c_str());</div></div><!-- fragment --><p>It does not remap Serial, so if you're using Serial.print for logging, you should switch to using Log.info instead.</p>
<p>The library creates a directory (default: "logs") at the top level of the SD card and stores the log files in that. Each log file is a .txt file 6-digit number beginning with 000001.txt.</p>
<p>The default log file is 1 MB (1000000 bytes), but you can reconfigure this. The actual size will be slightly larger than that, as the log is rotated when it exceeds the limit, and the file will always contain a whole log entry.</p>
<p>When rotated, the default is to keep 10 log files, but this is configurable. The oldest is deleted when the maximum number is reached.</p>
<p>By default, <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a> writes to Serial as well, like SerialLogHandler. This can be reconfigured.</p>
<p>This is the example program:</p>
<div class="fragment"><div class="line">#include &quot;Particle.h&quot;</div><div class="line"></div><div class="line">#include &quot;SdFat.h&quot;</div><div class="line">#include &quot;SdCardLogHandlerRK.h&quot;</div><div class="line"></div><div class="line">SYSTEM_THREAD(ENABLED);</div><div class="line"></div><div class="line">const int SD_CHIP_SELECT = A2;</div><div class="line">SdFat sd;</div><div class="line"></div><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED);</div><div class="line"></div><div class="line">size_t counter = 0;</div><div class="line"></div><div class="line">void setup() {</div><div class="line">    Serial.begin(9600);</div><div class="line">}</div><div class="line"></div><div class="line">void loop() {</div><div class="line">    Log.info(&quot;testing counter=%d&quot;, counter++);</div><div class="line">    delay(1000);</div><div class="line">}</div></div><!-- fragment --><h3>Initialize the SdFat library</h3>
<p>You normally initialize the SdFat library by creating a global object for it. For example:</p>
<div class="fragment"><div class="line">SdFat sd;</div></div><!-- fragment --><p>If you are using SPI1 (the D pins) instead, use:</p>
<div class="fragment"><div class="line">SdFat sd(1);</div></div><!-- fragment --><p>Note that you should not call <code>sd.begin()</code> in setup! The begin call is done by the <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a> because it needs to be done earlier than setup, and also every time the card is ejected.</p>
<p>If you need to check for a successful call to begin in your code, instead using <code>logHandler.getLastBeginResult()</code>. You might do this before using the SD card in your code. If there is no SD card inserted, the result will be false.</p>
<h3>Initialize the <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a></h3>
<p>Normally you initialize the <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a> by creating a global object like this:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED);</div></div><!-- fragment --><ul>
<li><code>sd</code> is the <code>SdFat</code> object, as described in the previous section</li>
<li><code>SD_CHIP_SELECT</code> is the pin connected to the CS/SS pin. In the code above, <code>SD_CHIP_SELECT</code> is set to A2.</li>
<li><code>SPI_FULL_SPEED</code> determines the speed to use, either full or <code>SPI_HALF_SPEED</code>.</li>
</ul>
<p>There are also two optional parameters:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);</div></div><!-- fragment --><p>The next optional parameter allows you to set the logging level.</p>
<ul>
<li><code>LOG_LEVEL_ALL</code> : special value that can be used to enable logging of all messages</li>
<li><code>LOG_LEVEL_TRACE</code> : verbose output for debugging purposes</li>
<li><code>LOG_LEVEL_INFO</code> : regular information messages</li>
<li><code>LOG_LEVEL_WARN</code> : warnings and non-critical errors</li>
<li><code>LOG_LEVEL_ERROR</code> : error messages</li>
<li><code>LOG_LEVEL_NONE</code> : special value that can be used to disable logging of any messages</li>
</ul>
<p>And finally, you can use logging categories as well to set the level for certain categories:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_INFO, {</div><div class="line">    { &quot;app.network&quot;, LOG_LEVEL_TRACE } </div><div class="line">});</div></div><!-- fragment --><p>That example defaults to INFO but app.network events would be at TRACE level.</p>
<h3>Using <a class="el" href="class_sd_card_print_handler.html" title="Class for writing a data stream to SD card. ">SdCardPrintHandler</a></h3>
<p>Instead of using <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a>, you can use <a class="el" href="class_sd_card_print_handler.html" title="Class for writing a data stream to SD card. ">SdCardPrintHandler</a>. This works like <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a>, except it does not hook into the system log handler. This makes it useful for logging arbitrary data, and not have system logs mixed in.</p>
<div class="fragment"><div class="line">SdCardPrintHandler printToCard(sd, SD_CHIP_SELECT, SPI_FULL_SPEED);</div></div><!-- fragment --><p>You can use any of the print, println, or printf methods to print to the log file. The same circular log file structure is used, and the card is only written to after a <br />
 or println. A line is never broken up across multiple files.</p>
<div class="fragment"><div class="line">printToCard.println(&quot;testing!&quot;);</div></div><!-- fragment --><h3>Options</h3>
<p>The options below work with both <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a> and <a class="el" href="class_sd_card_print_handler.html" title="Class for writing a data stream to SD card. ">SdCardPrintHandler</a>.</p>
<p>There are also options available to control how logging is done. For example, if you want to change the default log file size to (approximately) 50000 bytes:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);</div><div class="line">STARTUP(logHandler.withDesiredFileSize(50000));</div></div><!-- fragment --><p>You can chain these together fluent-style to change multiple settings:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);</div><div class="line">STARTUP(logHandler.withDesiredFileSize(50000).withMaxFilesToKeep(5));</div></div><!-- fragment --><p>By default, <a class="el" href="class_sd_card_log_handler.html" title="Class for logging to SD card. ">SdCardLogHandler</a> writes the log entries to Serial like SerialLogHandler. You can turn this off by using:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);</div><div class="line">STARTUP(logHandler.withNoSerialLogging());</div></div><!-- fragment --><p>Or if you want to log to Serial1 (or another port) instead:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);</div><div class="line">STARTUP(logHandler.withWriteToStream(&amp;Serial1);</div></div><!-- fragment --><p>Normally, a sync operation is done after each log entry, which maximizes the chance the the log entry will be written out to SD card successfully. However, this will slow down operation if you do a lot of logging. You can have the SdFat library manage its own sync, which happens about every 512 bytes of log messages, by turning off sync after every entry:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);</div><div class="line">STARTUP(logHandler.withSyncEveryEntry(false);</div></div><!-- fragment --><p>Finally, when the SD card is ejected, a check for being inserted is only done at most every 10 seconds. This is because there's a timeout operation that makes the operation slow, and doing it on every log entry would make the performance very bad. You can change this interval by using:</p>
<div class="fragment"><div class="line">SdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);</div><div class="line">STARTUP(logHandler.withCardCheckPeriod(30000);</div></div><!-- fragment --><p>The value is in milliseconds; that changes the value from 10 seconds to 30 seconds. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
